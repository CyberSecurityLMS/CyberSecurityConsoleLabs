# Уязвимость 5: Внедрение кода (Code Injection)

Это задание демонстрирует уязвимость внедрения кода, которая возникает, когда приложение передает непроверенные или недостаточно очищенные данные пользователя в динамический интерпретатор или функцию выполнения кода, такую как `eval()` в Python.

## Файлы

*   `vulnerable_app.py`: Уязвимое приложение, использующее `eval()` для вычисления математических выражений, введенных пользователем.
*   `fixed_app.py`: Исправленное приложение, использующее безопасный подход на основе разбора Abstract Syntax Tree (AST) для вычисления только разрешенных математических операций.

## Описание уязвимости

В `vulnerable_app.py` используется функция `eval()` для вычисления строки, переданной пользователем:

```python
# vulnerable_app.py
def calculate(expression):
    try:
        # УЯЗВИМОСТЬ: eval() выполняет строку как код Python
        result = eval(expression)
        # ...
```
Функция `eval()` очень мощная и опасная, так как она исполняет переданную строку как полноценный Python-код. Если злоумышленник передаст не математическое выражение, а вредоносный код Python (например, импорт модуля `os` и вызов `system`), этот код будет выполнен на сервере или машине, где запущено приложение.

## Эксплуатация

1.  **Запустите уязвимое приложение с безобидным математическим выражением:**
    ```bash
    python vulnerable_app.py "2 * (3 + 4)"
    ```
    Вы увидите ожидаемый результат `14`.

2.  **Запустите уязвимое приложение с вредоносным кодом:**
    *   **Linux/macOS:**
        ```bash
        python vulnerable_app.py "__import__('os').system('echo HACKED by Code Injection!')"
        ```
        Или чтобы увидеть список файлов:
        ```bash
        python vulnerable_app.py "__import__('os').system('ls -la')"
        ```
    *   **Windows:**
        ```bash
        python vulnerable_app.py "__import__('os').system('echo HACKED by Code Injection!')"
        ```
        Или чтобы увидеть список файлов:
        ```bash
        python vulnerable_app.py "__import__('os').system('dir')"
        ```

    Вы увидите, что команда операционной системы (`echo` или `ls`/`dir`) выполнилась, что подтверждает уязвимость внедрения кода. Злоумышленник может выполнить почти любую команду.

## Исправление

**Никогда не используйте `eval()` для обработки данных, полученных из ненадежного источника (например, от пользователя)!**

В `fixed_app.py` уязвимость устранена путем полного отказа от `eval()`. Вместо этого используется безопасный подход:

1.  **Разбор в AST:** Строка выражения разбирается в абстрактное синтаксическое дерево (AST) с помощью `ast.parse(expression, mode='eval')`. Это безопасно само по себе.
2.  **Рекурсивное вычисление AST:** Написана функция `safe_eval_math`, которая обходит узлы AST и выполняет только разрешенные операции (сложение, вычитание, умножение и т. д.) и разрешенные типы узлов (числа). Любые другие конструкции (вызовы функций, импорты, доступ к атрибутам) вызовут ошибку `TypeError`.

```python
# fixed_app.py
import ast
import operator as op

# Список разрешенных операторов и узлов
allowed_operators = { ... }
allowed_names = {} # Имена переменных не разрешены

def safe_eval_math(node):
    if isinstance(node, ast.Constant) and isinstance(node.value, (int, float)):
        return node.value
    elif isinstance(node, ast.BinOp) and type(node.op) in allowed_operators:
        # ... рекурсивный вызов для left и right ...
    # ... другие проверки на разрешенные узлы (UnaryOp) ...
    else:
        # Добавлена обработка корневого узла Expression
        if isinstance(node, ast.Expression):
            return safe_eval_math(node.body)
        raise TypeError(f"Узел типа {type(node).__name__} не разрешен")

def safe_calculate(expression):
    try:
        node = ast.parse(expression, mode='eval')
        result = safe_eval_math(node) # Вызов безопасного вычислителя
        # ...
```
Альтернативой может быть использование `ast.literal_eval`, если нужно обрабатывать только строки, числа, списки, словари, кортежи, булевы значения и `None`. `ast.literal_eval` безопаснее и проще, но не может выполнять даже простые математические операции.

## Проверка исправления

1.  **Запустите исправленное приложение с математическим выражением:**
    ```bash
    python fixed_app.py "2 * (3 + 4)"
    ```
    Вы увидите результат `14`.

2.  **Запустите исправленное приложение с вредоносным кодом:**
    ```bash
    python fixed_app.py "__import__('os').system('echo HACKED!')"
    ```
    Вы увидите сообщение об ошибке, например: `Ошибка безопасного вычисления ...: Узел типа Call не разрешен` или подобное (`TypeError: unsupported operand type(s) for unary -: 'str'` если парсер ожидает число). Вредоносный код не будет выполнен. Исправление работает. 