# Уязвимость 3: Небезопасная обработка файлов (Path Traversal)

Это задание демонстрирует уязвимость "Path Traversal" (Обход каталога), которая возникает, когда приложение недостаточно проверяет вводимые пользователем пути к файлам. Это позволяет злоумышленнику получить доступ к файлам за пределами разрешенной директории.

В данном примере мы адаптировали концепцию "File Upload Vulnerability" к консольному приложению, сосредоточившись на чтении файлов по небезопасным путям.

## Файлы

*   `vulnerable_app.py`: Уязвимое приложение, которое напрямую использует пользовательский ввод для построения пути к файлу без должной проверки.
*   `fixed_app.py`: Исправленное приложение, которое проверяет, что итоговый путь к файлу находится внутри ожидаемой базовой директории.
*   `user_files/welcome.txt`: Тестовый файл, который приложение должно безопасно читать (создается автоматически).

## Описание уязвимости

В `vulnerable_app.py` путь к файлу для чтения формируется путем простого соединения базовой директории (`BASE_DIR`) и имени файла, предоставленного пользователем:

```python
# vulnerable_app.py
file_path = os.path.join(BASE_DIR, filename)
# ...
with open(os.path.abspath(file_path), 'r', ...) as f:
    # ...
```
Функция `os.path.join` и `os.path.abspath` не предотвращают использование последовательностей типа `../` (или `..\` в Windows). Если пользователь введет что-то вроде `../../secret.txt`, итоговый путь может выйти за пределы `BASE_DIR` и указать на файл в родительских директориях.

## Эксплуатация

1.  **Создайте директорию и тестовый файл (если еще не созданы):**
    Запустите уязвимое приложение без аргументов один раз:
    ```bash
    python vulnerable_app.py
    ```
    Это создаст папку `user_files` и файл `user_files/welcome.txt`.

2.  **Прочитайте разрешенный файл:**
    ```bash
    python vulnerable_app.py welcome.txt
    ```
    Вы увидите содержимое файла `welcome.txt`.

3.  **Попытайтесь прочитать файл за пределами `user_files`:**
    *   **Linux/macOS:** Попробуйте прочитать файл `/etc/passwd` (если есть права):
        ```bash
        python vulnerable_app.py ../../../../../etc/passwd
        ```
    *   **Windows:** Попробуйте прочитать файл `hosts` (если есть права):
        ```bash
        python vulnerable_app.py ../../../../../Windows/System32/drivers/etc/hosts
        ```
        (Количество `../` может варьироваться в зависимости от глубины вашего рабочего каталога).

    Если у вас есть права на чтение этих файлов, уязвимое приложение отобразит их содержимое, демонстрируя уязвимость Path Traversal.

## Исправление

Уязвимость устранена в `fixed_app.py` путем проверки канонического пути.

1.  Получаем абсолютный путь к базовой директории (`ABS_BASE_DIR`).
2.  Формируем предполагаемый путь к файлу пользователя.
3.  Используем `os.path.abspath()` для получения канонического абсолютного пути к запрошенному файлу. Эта функция разрешает все `.` и `..`.
4.  **Ключевая проверка:** Убеждаемся, что полученный абсолютный путь (`abs_user_path`) начинается с абсолютного пути базовой директории (`ABS_BASE_DIR`). Это гарантирует, что файл находится внутри `BASE_DIR` или ее поддиректорий.

```python
# fixed_app.py
ABS_BASE_DIR = os.path.abspath(BASE_DIR)
# ...
abs_user_path = os.path.abspath(os.path.join(ABS_BASE_DIR, filename))
# ...
# Проверяем, что полученный путь НАЧИНАЕТСЯ с базовой директории
# Добавляем os.sep (разделитель пути) для точности сравнения
if not abs_user_path.startswith(ABS_BASE_DIR + os.sep) and abs_user_path != ABS_BASE_DIR:
    print(f"Ошибка доступа: Попытка чтения файла вне '{BASE_DIR}'.")
    return None
```

## Проверка исправления

1.  **Прочитайте разрешенный файл с помощью исправленного приложения:**
    ```bash
    python fixed_app.py welcome.txt
    ```
    Файл `welcome.txt` будет успешно прочитан.

2.  **Попытайтесь прочитать файл за пределами `user_files` с помощью исправленного приложения:**
    *   **Linux/macOS:**
        ```bash
        python fixed_app.py ../../../../../etc/passwd
        ```
    *   **Windows:**
        ```bash
        python fixed_app.py ../../../../../Windows/System32/drivers/etc/hosts
        ```
    Вывод покажет: **"Ошибка доступа: Попытка чтения файла вне 'user_files'."** Содержимое системного файла не будет прочитано. Исправление работает. 