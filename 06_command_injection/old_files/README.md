# Уязвимость 6: Инъекция команд (Command Injection)

Это задание демонстрирует уязвимость инъекции команд ОС. Она возникает, когда приложение строит команду для выполнения в операционной системе (например, через `os.system` или `subprocess` с `shell=True`), включая в нее непроверенные данные от пользователя. Злоумышленник может внедрить специальные символы (`;`, `&`, `|`, `&&`, `||` и т.д.), чтобы выполнить дополнительные, несанкционированные команды.

## Файлы

*   `vulnerable_app.py`: Уязвимое приложение, которое конкатенирует ввод пользователя со строкой команды `ping` и выполняет ее через `os.system()`.
*   `fixed_app.py`: Исправленное приложение, которое использует `subprocess.run()` с передачей команды и аргументов в виде списка, что безопасно.

## Описание уязвимости

В `vulnerable_app.py` команда `ping` формируется так:

```python
# vulnerable_app.py
command = base_command + hostname # hostname - ввод пользователя
# ...
exit_code = os.system(command)
```
Функция `os.system()` передает полученную строку (`command`) командной оболочке операционной системы (как если бы вы набрали ее в терминале). Оболочка интерпретирует специальные символы. Если `hostname` содержит, например, `google.com ; ls`, то оболочка сначала выполнит `ping ... google.com`, а *затем* выполнит команду `ls`.

## Эксплуатация

1.  **Запустите уязвимое приложение с обычным хостом:**
    ```bash
    python vulnerable_app.py google.com
    ```
    Вы увидите результат выполнения команды `ping`.

2.  **Запустите уязвимое приложение с внедренной командой:**
    *   **Linux/macOS:** Используйте точку с запятой `;` для разделения команд.
        ```bash
        # Выполнит ping, а затем echo
        python vulnerable_app.py "google.com ; echo HACKED by Command Injection"
        ```
        ```bash
        # Выполнит ping, а затем ls -la
        python vulnerable_app.py "google.com ; ls -la"
        ```
    *   **Windows:** Используйте амперсанд `&` или `&&` для разделения команд.
        ```bash
        # Выполнит ping, а затем echo
        python vulnerable_app.py "google.com & echo HACKED by Command Injection"
        ```
        ```bash
        # Выполнит ping, а затем dir
        python vulnerable_app.py "google.com & dir"
        ```
    Вы увидите, что после вывода `ping` выполнилась и вторая команда (`echo`, `ls` или `dir`), что подтверждает уязвимость.

## Исправление

**Никогда не передавайте необработанные данные пользователя напрямую в функции, исполняющие команды ОС в оболочке (`os.system`, `subprocess` с `shell=True`)!**

В `fixed_app.py` уязвимость устранена использованием модуля `subprocess` безопасным способом:

1.  **Команда как список:** Команда и ее аргументы передаются в `subprocess.run()` не одной строкой, а списком. Каждый элемент списка считается отдельным аргументом.
2.  **`shell=False` (по умолчанию):** Важно, что `subprocess.run()` вызывается без `shell=True`. В этом режиме Python напрямую запускает указанную программу (например, `ping`), передавая ей аргументы из списка. Командная оболочка ОС не используется для интерпретации строки, и специальные символы `;`, `&` и т.д. не имеют особого значения – они передаются команде `ping` как часть имени хоста (что, скорее всего, приведет к ошибке разрешения имени, но не к выполнению доп. команды).

```python
# fixed_app.py
import subprocess

def safe_check_host(hostname):
    # ... определить command_args как список ...
    command_args = ["ping", "-c", "1", hostname] # Пример для Linux
    # ...
    try:
        # shell=False по умолчанию
        result = subprocess.run(command_args, ...)
        # ...
```
Если бы все же было необходимо использовать `shell=True` (что крайне не рекомендуется с пользовательским вводом), то ввод нужно было бы тщательно экранировать с помощью `shlex.quote()`.

## Проверка исправления

1.  **Запустите исправленное приложение с обычным хостом:**
    ```bash
    python fixed_app.py google.com
    ```
    Вы увидите результат выполнения `ping`, как и ожидалось.

2.  **Запустите исправленное приложение с попыткой внедрения команды:**
    *   **Linux/macOS:**
        ```bash
        python fixed_app.py "google.com ; ls -la"
        ```
    *   **Windows:**
        ```bash
        python fixed_app.py "google.com & dir"
        ```
    Вы увидите вывод `subprocess.run`, показывающий команду и аргументы как `['ping', '-c', '1', 'google.com ; ls -la']` (или аналогично для Windows). Команда `ping` попытается разрешить имя хоста `"google.com ; ls -la"` (или `"google.com & dir"`), что приведет к ошибке разрешения имени ("unknown host" или подобное). Важно, что команда `ls -la` или `dir` **не будет** выполнена. Исправление работает. 